<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-styles/paper-styles.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../paper-material/paper-material.html">
<link rel="import" href="../cg-base/cg-required-validator.html">
<link rel="import" href="../cg-base/cg-validatable-behavior.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-menu/paper-menu.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../iron-a11y-keys/iron-a11y-keys.html">
<link rel="import" href="../font-awesome-polymer-icons/fa-icons.html">
<link rel="import" href="../cg-dropdown/cg-dropdown.html">
<link rel="import" href="../cg-behaviors/cg-base-behavior.html">
<link rel="import" href="../cg-behaviors/cg-application-datasource-aware-behavior.html">

<dom-module id="cg-input-tags">
    <style>
        .wrapper {
            @apply(--paper-font-body1);
        }
        .wrapper .tag-input {
            cursor: text;
        }
        .wrapper .select {
            cursor: pointer;
        }
        .wrapper .placeholder {
            color:#9a9a9a;
        }
        .wrapper .tags .tag.selected  {
            outline:0;
        }
        .wrapper .tags .tag {
            margin:3px;
            cursor:pointer;
        }
        .wrapper .tags .tag span {
            margin:3px;
            cursor:pointer;
        }
        .wrapper .tags .tag paper-material{
            border-radius: 5px;
        }
        .wrapper .tags .tag iron-icon:hover {
            background-color:#dddddd;
        }
        .wrapper .tags .tag iron-icon {
            width:16px;
            height:16px;
            color:#d34336;
        }
        .wrapper iron-icon {
            color:rgb(0, 150, 136);
        }
        .wrapper cg-dropdown paper-item.preselected,
        .wrapper cg-dropdown paper-item:hover {
            background-color:#dddddd;
        }

        .wrapper cg-dropdown ::content #dd_content {
            max-height:200px;
            overflow:auto;
            margin:5px;
        }

        .wrapper .tag-input {
            @apply(--layout-horizontal);
        }
        .wrapper .tag-input .tags-wrapper {
            @apply(--layout-flex);
        }
        .wrapper .tag-input .tags-wrapper .tags {
            @apply(--layout-horizontal);
            @apply(--layout-wrap);
            @apply(--layout-center);
        }
        .wrapper .tag-input .tags-wrapper .tags .tag {
            @apply(--layout-horizontal);
            @apply(--layout-center);
            @apply(--layout-relative);
        }
        .wrapper .tag-input .tags-wrapper .tags .tag paper-material {
            @apply(--layout-fit);
        }
    </style>
    <template>
        <div class="wrapper">
            <cg-required-validator required="[[required]]"></cg-required-validator>
            <div on-tap="_select" class="tag-input" id="tagInput" tabindex="0" >
                <div class="tags-wrapper">
                    <span class="placeholder" hidden$="[[isGreaterThan(selected.length, 0)]]">[[label]]</span>
                    <div id="tags" class="tags">
                        <template is="dom-repeat" items="[[selected]]" as="tag" >
                            <div tabindex="0" class="tag"
                                 on-focus="_onSelectTag"
                                 on-blur="_onUnselectTag"
                                 on-tap="_onSelectTag"  data-index$="[[index]]" data-tag$="[[tag]]">
                                <paper-material elevation="1" animated fit></paper-material>
                                <span>[[tag]]</span>
                                <iron-icon icon="fa:minus-circle" on-tap="_onDelete" data-tag$="[[tag]]"></iron-icon>
                            </div>
                        </template>
                    </div>
                </div>
                <div>
                    <iron-icon tabindex="0" class="select" icon="fa:caret-down" ></iron-icon>
                </div>
            </div>
            <cg-dropdown id="dd" class="dropdown" owner-target="[[self]]">
                <paper-input dd-header autofocus tabindex="0" id="search" label="Search or new"  on-keyup="_search" on-keypress="_selectOrNew"></paper-input>
                <paper-menu dd-content class="menu" id="menu">
                    <template is="dom-repeat" items="[[_tagsView]]" as="tag">
                        <paper-item class="tag-item" on-focus="_preselectItem" on-blur="_deselectItem" tabindex="0" data-tag$="[[tag]]">[[tag]]</paper-item>
                    </template>
                </paper-menu>
            </cg-dropdown>
            <!--<core-a11y-keys id="ally" target="{{$.tags}}" keys="del" on-keys-pressed="{{_handleTagKey}}"></core-a11y-keys>-->
            <!--<core-a11y-keys id="ally1" target="{{$.tagInput}}" keys="down enter" on-keys-pressed="{{_handleDDKey}}"></core-a11y-keys>-->
            <!--<core-a11y-keys id="ally2" target="{{$.menu}}" keys="enter" on-keys-pressed="{{_handleDDListKey}}"></core-a11y-keys>-->
        </div>
    </template>
    <script>
        Polymer({
            is:"cg-input-tags",
            properties:{
                cgName:{
                    type:String,
                    value:"tags"
                },
                label:String,
                tags:{
                    type:Array,
                    observer:'tagsChanged'
                },
                selected:{
                    type:Array,
                    value:[],
                    notify:true,
//                    observer:'selectedChanged'
                },
                required:{
                    type:Boolean,
                    value:false
                },
                _tags:{
                    type:Array,
                    value:[],
                    observer:'_tagsChanged'
                },
                _tagsView:{
                    type:Array,
                    value:[]
                },
                validator:{
                    type: String,
                    value: 'cg-required-validator'
                }
            },
            behaviors:[CG.BaseBehavior, CG.ApplicationDataSourceAwareBehavior,CG.ValidatableBehavior],
            listeners:{
                'iron-activate':'_onAdd',
                'click':'cancelEvent'
            },
            observers:[
                '_tagsChanged(_tags.splices)',
                'selectedChanged(selected.splices)',
                'tagsChanged(tags.splices)',
            ],
            ready:function(){
                if(this.tags == null) {
                    console.log(this.toString(), "no tags provided firing data request");
                    this.fireDataRequest({
                        type:'data',
                        success:function(response){
                            this.tags = response.data;
                            this.async(this.selectedChanged.bind(this), null, 100)
                        }.bind(this),
                        failure:function(response){}.bind(this)
                    });
                }else{
                    console.log(this.toString(), "tags provided, using them");
                }
            },
            tagsChanged:function(){
                this._tags = this.tags.slice();
            },
            selectedChanged:function(changes){
                if(!this.tags || !this.selected) {
                    return;
                }
                for(var i = 0; i < this.selected.length; i++){
                    var tag = this.selected[i];
                    var index = this._tags.indexOf(tag);
                    index != -1 && this.splice("_tags", index, 1);
                }
                changes && this.fire("input", this.selected);
            },
            _onUnselectTag:function(e){
                this._unselectTag(e.currentTarget);
                e.stopPropagation();
            },
            _unselectTag:function(e){
                e.classList.remove("selected");
                e.querySelector("paper-material").elevation = 1;
            },
            _onSelectTag:function(e){
                var selected = this.querySelector(".tag.selected");
                selected && this._unselectTag(selected);
                this._selectTag(e.currentTarget);
                e.stopPropagation();
            },
            _selectTag:function(e){
                e.classList.add("selected");
                e.querySelector("paper-material").elevation = 2;
                e.focus();
            },
            _tagsChanged:function(){
                this.set("_tagsView", this._tags.slice());
            },
            _select:function(e){
                this.$.dd.toggle();
            },
            _onDelete:function(e){
                this.cancelEvent(e);
                this._delete(e.currentTarget);
            },
            _delete:function(e){
                for(var i = 0; i < this.selected.length; i++) {
                    if(this.selected[i] == e.dataset.tag) {
                        var o = this.splice("selected", i, 1)[0];
                        if (this.tags.indexOf(o) != -1) {
                            this.splice("_tags", 0, 0, o);
                        }
                        break;
                    }
                }
            },
            _onAdd:function(e) {
                this._add(e.detail.item.dataset.tag);
            },
            _add:function(tag){
                if(this.selected.indexOf(tag) != -1) {
                    return;
                }
                this.push("selected", tag);
                this.$.menu.selected = null;
            },
            _selectOrNew:function(e){
                if(e.keyCode != 13) {
                    return;
                }
                if(this._tagsView.length == 1) {
                    this._add(this._tagsView[0]);
                }else{
                    var tag = this.$.search.value;
                    for(var i = 0; i < this.selected.length; i++) {
                        if(this.selected[i] == tag) {
                            return;
                        }
                    }
                    this.push("selected", tag);
                }
            },
            _search:function(e){
                var highRelevance = [];
                var lowRelevance = [];
                this._tags.forEach(function(e){
                    var bounds = this._getMatchBounds(e);
                    if(bounds.matches) {
                        if (bounds.from == 0) {
                            highRelevance.push(e);
                        } else {
                            lowRelevance.push(e);
                        }
                    }
                }, this);
                var results = highRelevance.concat(lowRelevance);
                this._tagsView = results;
            },
            _getMatchBounds:function(tag){
                var search = String(this.$.search.value).toLowerCase();
                if(search.length == 0) {
                    return {
                        empty : true,
                        matches : true,
                        from : -1,
                        to : -1
                    };
                }
                var value = tag.toLowerCase();
                var from =  value.indexOf(search);
                var matches =  from > -1;
                var to = matches ? from + search.length : -1;
                return {
                    empty:false,
                    matches: from > -1,
                    from: from,
                    to: to
                };
            },
            _deselectItem:function(e){
                e.currentTarget.classList.remove("preselected");
            },
            _preselectItem:function(e){
                e.currentTarget.classList.add("preselected");
                e.currentTarget.focus();
            },
            _handleDDListKey:function(e, detail, sender){
                var preselected = this.$.menu.querySelector("paper-item.tag-item.preselected")
                if(preselected) {
                    this.$.menu.selected = preselected;
                    this._add(preselected.dataset.tag);
                    if(preselected.previousElementSibling.classList.contains("tag-item")) {
                        preselected.previousElementSibling.focus();
                    }else if(preselected.nextElementSibling.classList.contains("tag-item")) {
                        preselected.nextElementSibling.focus();
                    }
                }
            },
            _handleDDKey:function(e, detail, sender){
                if(document.activeElement.classList.contains("tag")) {
                    return;
                }
                this._select();
            },
            _handleTagKey:function(e, detail, sender){
                if(detail.key == "down" || detail.key == "enter") {
                    e.stopPropagation();
                    return;
                }
                var selected = this.querySelector(".tag.selected");
                if(selected) {
                    this._delete(selected);
                    this.async(function(){
                        if (this.selected.length > 0) {
                            var tag = this.querySelector(".tag[data-index='" + (selected.dataset.index) + "']");
                            if(!tag) {
                                tag = this.querySelector(".tag[data-index='" + (selected.dataset.index - 1) + "']");
                            }
                            this._selectTag(tag);
                        }
                    }.bind(this), null, 100);

                }
            }
        });
    </script>
</dom-module>